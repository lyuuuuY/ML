---
title: "Assignment 3"
author: "Cui Qingxuan"
date: "`r Sys.Date()`"
output: pdf_document
---

# Before Everything: Cope with raw data

Load it first

```{r load csv}
data = read.csv("pima-indians-diabetes.csv")
head(data)
```

Apparently it is not accessible enough.

```{r}
colnames(data) = list("pegnant_times", "glucose_level", "blood_pressure", "skin_thickness", "serum_insulin", "boby_mass", "diabetes_pedigree_func", "age", "diabetes")
head(data)
```

# 1. Scatter Plot

The mapping of plot would be (age, glucose level)

```{r plot}
library(ggplot2)

ggplot(data, aes(age, glucose_level, color = as.factor(diabetes))) + 
      geom_point(size = 2) +
      labs(title = "Scatter Plot between Age and Glucose Level",
            x = "Age", 
            y = "Glucose Level") + 
       scale_color_manual(values = c("0" = "green", "1" = "red")) +
      theme_minimal()
```

My answer about whether given 2 variables can classify diabetes levels via logistic regression To be honst, in such a dimension, I cannot find a clear boudary to classify 2 groups.

# 2. Train the Logistic Regression

## 2.1 Data Processing

```{r}
model_data = as.data.frame(x = cbind(data$glucose_level, data$age, data$diabetes))
colnames(model_data) = list("x1", "x2", "label")

head(model_data)

```

## 2.2 Model Train

```{r model construction}
library(lattice)
library(caret)
model = train(as.factor(label) ~ ., 
              data = model_data, 
              method = "glm", 
              family = "binomial")
summary(model)
```

## 2.3 Probabilistic Equation

report required there

## 2.5 Calculate Loss

```{r Output}
output_prob = predict(model, model_data, type = "prob")[,2]
output_label  = ifelse(output_prob >= 0.5, 1, 0)
head(output_label)

loss  = mean((as.numeric(output_label) - as.numeric(model_data$label)) ** 2)
loss

acc = mean(output_label == model_data$label)
acc
```

## 2.4 Plot agin

```{r}
ggplot(cbind(model_data,output_label), aes(x2, x1, color = as.factor(output_label))) + 
      geom_point(size = 2) +
      labs(title = "Scatter Plot between Age and Glucose Level",
            x = "Age", 
            y = "Glucose Level") + 
       scale_color_manual(values = c("0" = "green", "1" = "red")) +
      theme_minimal()
```

## 2.5 Comment on the Classification Quality

lalala

# 3. Find the boundary

## 3.1 Add the Cruve in Plot

```{r}
coeff = coef(model$finalModel)

intercept = coeff[1]
param_x1 = coeff[2]
param_x2 = coeff[3]


cat("Boundary Decisionï¼š", intercept, "+", param_x1, "* x1 +", param_x2, "* x2 = 0")
```

```{r}
# create the gird
x2_range = seq(min(model_data$x2), max(model_data$x2), length.out = dim(model_data))
x1_bound = -(intercept + param_x2 * x2_range) / param_x1


ggplot(cbind(model_data,output_label), aes(x2, x1)) + 
      geom_point(aes(color = as.factor(output_label)),size = 2) +
       geom_line(aes(x = x2_range, y = x1_bound), color = "black", linetype = "dashed") + 
      labs(title = "Scatter Plot between Age and Glucose Level",
            x = "Age", 
            y = "Glucose Level") + 
       scale_color_manual(values = c("0" = "green", "1" = "red")) +
      theme_minimal()
```

## 3.2 Comment on Decision Boundary

pass

# 4. Set Different Threholds in Plot
## 4.1 Code
```{r}
r = c(0.2, 0.8)
output_label  = ifelse(output_prob >= r[1], 1, 0)

ggplot(cbind(model_data,output_label), aes(x2, x1, color = as.factor(output_label))) + 
      geom_point(size = 2) +
      labs(title = "Scatter Plot between Age and Glucose Level",
            x = "Age", 
            y = "Glucose Level") + 
       scale_color_manual(values = c("0" = "green", "1" = "red")) +
      theme_minimal()

output_label  = ifelse(output_prob >= r[2], 1, 0)

ggplot(cbind(model_data,output_label), aes(x2, x1, color = as.factor(output_label))) + 
      geom_point(size = 2) +
      labs(title = "Scatter Plot between Age and Glucose Level",
            x = "Age", 
            y = "Glucose Level") + 
       scale_color_manual(values = c("0" = "green", "1" = "red")) +
      theme_minimal()
```

## 4.2Comments
pass

# 5. Trick

## 5.1 Data Processing

```{r}
label = model_data$label
model_data$label = NULL

for (i in 0:4){
  feature_name = paste0("z", as.character(i+1))
  model_data[[feature_name]] = (model_data$x1 ** (4 - i)) * (model_data$x2 ** i)
}
model_data$label = label
head(model_data)
```

## 5.2 Plot

```{r}
model = train(as.factor(label) ~ ., 
              data = model_data, 
              method = "glm", 
              family = "binomial")

summary(model)

output_prob = predict(model, model_data, type = "prob")[,2]
output_label  = ifelse(output_prob >= 0.5, 1, 0)
head(output_label)

loss  = mean((as.numeric(output_label) - as.numeric(model_data$label)) ** 2)
loss

acc = mean(output_label == model_data$label)
acc
```

```{r}
db_points = model_data[abs(output_prob - 0.5) < 0.05,]

ggplot() +
  geom_point(data = cbind(model_data, output_label), aes(x = x2, y = x1, color = as.factor(output_label))) +
  labs(title = "Scatter Plot between Age and Glucose Level",
       x = "Age", 
       y = "Glucose Level") + 
  scale_color_manual(values = c("0" = "green", "1" = "red")) +
  geom_smooth(data = db_points, aes(x = x2, y = x1), method = "loess",color = "black", linetype = "dashed") +
  theme_minimal()

               
```

# 5.3 Report
lalala